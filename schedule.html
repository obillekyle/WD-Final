<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <link rel="stylesheet" href="./styles/index.css" />

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@3.0.0/dist/iconify-icon.min.js"></script>
    <script src="./script/index.js" type="module"></script>

    <script src="./script/page/schedule.js" type="module"></script>
  </head>

  <body>
    <w-app>
      <w-navigation>
        <img src="./assets/logo.webp" alt="Logo" id="nav-logo" />
        <w-navigation-list>
          <w-navigation-item
            icon="material-symbols:home-outline"
            href="./dashboard.html"
            match="\/dashboard"
          >
            Home
          </w-navigation-item>
          <w-navigation-item
            desktop
            icon="mdi:teach"
            href="./faculty.html"
            match="\/faculty"
          >
            Faculty
          </w-navigation-item>
          <w-navigation-item
            desktop
            icon="material-symbols:book-ribbon-outline"
            href="./subject.html"
            match="\/subject"
          >
            Subjects
          </w-navigation-item>
          <w-navigation-item
            desktop
            icon="material-symbols:group-outline"
            href="./section.html"
            match="\/section"
          >
            Sections
          </w-navigation-item>
          <w-navigation-item
            desktop
            icon="material-symbols:meeting-room-outline"
            href="./room.html"
            match="\/room"
          >
            Rooms
          </w-navigation-item>
          <w-navigation-item
            mobile
            icon="material-symbols:id-card-outline"
            href="./data.html"
            match="\/data"
          >
            Data
          </w-navigation-item>
          <w-navigation-item
            icon="material-symbols:calendar-month-outline"
            href="./schedule.html"
            match="\/schedule"
          >
            Schedule
          </w-navigation-item>
        </w-navigation-list>

        <div class="account"> </div>
      </w-navigation>
      <w-content>
        <w-breakpoint>
          <w-header> Schedule Management </w-header>
          <div class="flex-col gap-md">
            <div class="flex gap-xxs" id="scheduleChips">
              <w-chip icon="material-symbols:meeting-room-outline">Room</w-chip>
              <w-chip
                icon="material-symbols:book-ribbon-outline"
                variant="outlined"
                >Subject</w-chip
              >
              <w-chip icon="material-symbols:group-outline" variant="outlined"
                >Section</w-chip
              >
            </div>
            <w-box id="scheduleInput"></w-box>
          </div>

          <table class="sched-table">
            <thead>
              <tr>
                <th></th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </w-breakpoint>
      </w-content>
    </w-app>

    <form class="sidebar" onsubmit="return false" onclick="closeSidebar(event)">
      <div class="sidebar-content">
        <div title>Faculty Management</div>

        <div class="flex-col gap-md w-fill">
          <w-dropdown
            icon="material-symbols:group-outline"
            id="facultyInput"
            label="Faculty Member"
            required
          ></w-dropdown>

          <w-dropdown
            icon="material-symbols:meeting-room-outline"
            label="Room"
            id="roomInput"
            required
          >
          </w-dropdown>

          <w-dropdown
            icon="material-symbols:book-ribbon-outline"
            id="subjectInput"
            label="Subject"
            required
          >
          </w-dropdown>

          <w-dropdown
            icon="material-symbols:group-outline"
            id="sectionInput"
            label="Section"
            required
          >
          </w-dropdown>
          <w-dropdown
            icon="material-symbols:calendar-month-outline"
            id="dayInput"
            label="Day"
            required
          >
          </w-dropdown>
          <div class="flex gap-xxs">
            <w-dropdown
              icon="material-symbols:timer-outline"
              id="startInput"
              label="Start"
              required
            >
            </w-dropdown>
            <w-dropdown
              icon="material-symbols:timer-outline"
              id="endInput"
              label="End"
              required
            >
            </w-dropdown>
          </div>
        </div>

        <div class="flex gap-auto">
          <w-button>Delete</w-button>
          <w-button type="submit">Save</w-button>
        </div>
      </div>
    </form>

    <!-- <script type="module">
      import {
        qAll$,
        q$,
        newElement,
        getUppercaseLetters,
      } from '../script/utils.js';
      import { faculties, rooms, subjects, students } from '../script/data.js';

      /**
       * @type {Array<{ subject: string; faculty: string; room: string; section: string; day: string; range: string[] }>}
       */

      const now = new Date();
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];


      function updateTable() {
        const today = days[now.getDay()];
        resetTable();

        qAll$(`.sched-table th`).forEach((th) => {
          if (th.textContent.includes(today)) {
            th.classList.add('highlight-today');
          }
        });

        const rows = document.querySelectorAll('.sched-table tbody tr');

        data.forEach((entry, index) => {
          if (!entry.day) return;

          const colIndex = dayToCol[entry.day];
          if (colIndex === undefined) return;

          const startIndex = timeRows.findIndex((t) => t === entry.range[0]);
          const endIndex = timeRows.findIndex((t) => t === entry.range[1]);

          if (startIndex === -1 || endIndex === -1) return;

          for (let i = startIndex; i < endIndex; i++) {
            const row = rows[i];
            const cells = row.querySelectorAll('td');
            const cell = cells[colIndex];

            const span = endIndex - startIndex;

            if (cell && i === startIndex) {
              cell.setAttribute('rowspan', span);
              cell.classList.add(colors[index % colors.length]);
              cell.innerHTML = `
                <div class="subject">${entry.subject}</div>
                <div class="teacher">${entry.faculty}</div>
                <div class="room">${entry.room}</div>
                <div class="section">${getUppercaseLetters(entry.section)}</div>
              `;
            } else if (cell) {
              cell.remove();
            }
          }
        });
      }

      updateTable();

      document.addEventListener('click', (e) => {
        const target = e.target;
        const tooltip = q$('.selection');

        if (!target || !(target instanceof HTMLElement)) return;

        if (target.matches('.sched-table tbody td:not(.time)')) {
          if (target.matches('.highlight')) {
            getCellData(target);
            showSidebar();
            return;
          }

          q$('.highlight')?.classList.remove('highlight');
          target.classList.add('highlight');
        }
      });

      const datalistFaculties = q$('#faculties');

      faculties.forEach((faculty) => {
        datalistFaculties.appendChild(
          newElement('option', { value: faculty.name })
        );
      });

      const datalistRooms = q$('#rooms');

      Object.entries(rooms).forEach(([key, value]) => {
        datalistRooms.appendChild(newElement('option', { value: key }));
      });

      const datalistSubjects = q$('#subjects');

      Object.entries(subjects).forEach(([key, value]) => {
        datalistSubjects.appendChild(
          newElement('option', { value: key.toUpperCase() })
        );
      });

      function processSection() {
        const letters = getUppercaseLetters();
      }

      const datalistSections = q$('#sections');

      students.forEach(({ program, yearLevel, section }) => {
        datalistSections.appendChild(
          newElement('option', { value: `${program} ${yearLevel} ${section}` })
        );
      });

      const datalistTimes = q$('#times');

      timeRows.forEach((time) => {
        datalistTimes.appendChild(newElement('option', { value: time }));
      });

      function showSidebar() {
        const sidebar = q$('.sidebar');

        if (!sidebar) return;

        sidebar.classList.toggle('open');
      }

      function closeSidebar(event) {
        if (!event) {
          q$('.sidebar').classList.remove('open');
          return;
        }

        const sidebar = event.currentTarget;

        if (sidebar != event.target) return;

        sidebar.classList.remove('open');
      }

      function saveSchedule(event) {
        const form = q$('form');

        if (!(form instanceof HTMLFormElement)) return;

        if (form.checkValidity()) {
          const facultyInput = q$('#facultyInput input');
          const roomInput = q$('#roomInput input');
          const subjectInput = q$('#subjectInput input');
          const sectionInput = q$('#sectionInput input');
          const hoursInput = q$('#hoursInput input');

          console.log(facultyInput, roomInput, subjectInput, sectionInput);

          event.preventDefault();

          const hours = getHours(q$('.highlight'), hoursInput.value);

          const dataNew = {
            day: hours.day,
            range: hours.range,
            faculty: facultyInput.value,
            room: roomInput.value,
            subject: subjectInput.value,
            section: sectionInput.value,
          };

          data.push(dataNew);
          console.log(dataNew);

          alert('Schedule saved.');

          closeSidebar();
          updateTable();
          return;
        }

        alert('Please fill out all fields.');
        return;
      }

      window.saveSchedule = saveSchedule;
      window.closeSidebar = closeSidebar;

      function getHours(cell, hours) {
        const table = cell.closest('table');

        if (!table) return;

        let row = Number(cell.getAttribute('data-row'));
        let index = Number(cell.getAttribute('data-column'));

        return {
          day: Object.keys(dayToCol)[index],
          range: [timeRows[row], timeRows[row + hours * 2]],
        };
      }

      function resetTable() {
        const table = q$('.sched-table tbody');

        if (!table) return;
        table.innerHTML = '';

        timeRows.forEach((time, index) => {
          const row = newElement('tr', {
            append: [
              newElement('td', { class: 'time', textContent: time }),
              newElement('td', { 'data-column': 0, 'data-row': index }),
              newElement('td', { 'data-column': 1, 'data-row': index }),
              newElement('td', { 'data-column': 2, 'data-row': index }),
              newElement('td', { 'data-column': 3, 'data-row': index }),
              newElement('td', { 'data-column': 4, 'data-row': index }),
              newElement('td', { 'data-column': 5, 'data-row': index }),
            ],
          });
          table.appendChild(row);
        });
      }

      function getCellData(target) {
        const [eSubject, eFaculty, eRoom, eSection] = target.textContent
          .trim()
          .split('\n')
          .map((e) => e.trim());
        const hours = Number(target.getAttribute('rowspan') || 0) / 2;

        const facultyInput = q$('#facultyInput input');
        const roomInput = q$('#roomInput input');
        const subjectInput = q$('#subjectInput input');
        const sectionInput = q$('#sectionInput input');
        const hoursInput = q$('#hoursInput input');

        facultyInput.value = eFaculty || '';
        roomInput.value = eRoom || '';
        subjectInput.value = eSubject || '';
        sectionInput.value = eSection || '';
        hoursInput.value = hours || '';
      }
    </script> -->
  </body>
</html>
